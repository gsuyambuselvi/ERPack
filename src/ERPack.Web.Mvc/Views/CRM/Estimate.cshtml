@using ERPack.Web.Startup
@using ERPack.Web.Models.CRM
@model AddEditEstimateModel
@{
    ViewBag.Title = L("Estimate");
    ViewBag.CurrentPageName = PageNames.CreateEstimate;
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/CRM/EstimatesList">Estimates List</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <form id="estimateCreateForm">
            <input id="id" type="hidden" Name="Id" class="form-control" value="@Model.Id">
            <!-- First Section: Cards Side by Side -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <!-- Left Card: Estimate Details -->

                        <div class="col-md-7 ">
                            <div class="p-3 d-flex flex-column border rounded-lg h-100">
                                <div class="row">
                                    <div class="col-md-7">
                                   
                                        <!-- Estimate ID -->
                                        <div class="form-group col-lg-9">
                                            <label for="EstimateId">Estimate ID</label>
                                            <div class="input-group mb-3">                                             
                                                <input type="text" class="form-control" id="EstimateId"
                                                    value="@Model.EstimateId" name="EstimateId" required readonly>
                                            </div>
                                        </div>

                                        <!-- Description -->
                                        <div class="form-group col-lg-9">
                                            <label for="Description">Description</label>
                                            <div class="input-group mb-3">                                              
                                                <textarea type="text" class="form-control" id="Description"
                                                    name="Description" value="@Model.Description" required></textarea>
                                            </div>
                                        </div>
                                        @if (Model.DesignId != null)
                                        {
                                            <input type="hidden" class="form-control" id="designId" name="DesignId"
                                                value="@Model.DesignId">
                                            <input type="hidden" class="form-control" id="editIsKit"
                                                value="@Convert.ToString(Model.IsKit)">
                                            <input type="hidden" class="form-control" id="editIsIncludeMaterial"
                                                value="@Convert.ToString(Model.IsIncludeMaterial)">
                                        }

                                        <!-- Design ID -->
                                        <div class="form-group col-lg-9">
                                            <label for="DesignId">Design ID</label>
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" id="DesignId"
                                                    value="@Model.DesignId" required readonly>
                                            </div>
                                        </div>
                                       
                                        <!-- Checkboxes -->
                                        <div class="form-group row">
                                            <div class="col-sm-12" style="padding-left: 20px;">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="asKit"
                                                        name="asKit">
                                                    <label for="asKit" class="form-check-label">Package as Kit</label>
                                                </div>

                                            </div>
                                            <div class="col-sm-12 d-flex mt-2" style="padding-left: 20px;">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" disabled
                                                        id="includeMaterial" name="includeMaterial">
                                                    <label for="includeMaterial" class="form-check-label">Include
                                                        Material</label>
                                                </div>
                                                <div class="form-check ml-3">
                                                    <input type="checkbox" class="form-check-input" id="includeImage"
                                                        name="includeImage">
                                                    <label for="includeImage" class="form-check-label">Include
                                                        Image</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Image Preview Control -->
                                    <div class="col-lg-5 image-container">
                                        <div class="form-group ">
                                            <div class="file">                                           
                                                <div class="d-flex justify-content-between align-items-center"
                                                    style="margin-bottom: 30px;">
                                                    <span style="font-weight: bold;">Design Image Viewer</span>                                                 
                                                </div>
                                                <div id="filePreview" class="border rounded mb-3">
                                                    <input type="hidden" id="hdnDesignImage" name="DesignImage" />

                                                    <img id="designImage" src="" data-filetype="image"
                                                        data-role="other-image" alt="" style="display:none" />
                                                    <embed id="pdfPreview" src="" data-filetype="pdf"
                                                        data-role="pdf-image" type="application/pdf"
                                                        style="display:none" />

                                                    <!-- Placeholder for empty file -->
                                                    @* <div id="emptyFilePlaceholder"  *@
                                                    @*      class="d-flex flex-column justify-content-center align-items-center"  *@
                                                    @*     style="height: 200px; display: none;">  *@
                                                    @*      <i class="far fa-file-alt fa-2x" style="color: #326bcd;"></i>  *@
                                                    @*      <p class="text-muted mt-2">No file to display</p>  *@
                                                    @*  </div>  *@


                                                    <div id="myModal" class="modal" data-role="modal">
                                                        <span class="close">&times;</span>
                                                        <div class="modal-content">
                                                            <img id="designImagemodal" src="" data-filetype="image"
                                                                data-role="modal-image" alt="" />
                                                            <embed id="pdfPreviewmodal" src="" data-filetype="pdf"
                                                                data-role="modal-pdf" type="application/pdf" />
                                                            <input type="range" min="1" max="3" step="0.1" value="1"
                                                                class="zoom-slider" id="zoomSlider">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-2">
                                                    <div class="icon-buttons" id="icon-buttons">
                                                        <button type="button" id="magnify"
                                                            class="btn btn-outline-primary btn-sm  mx-2" data-role="magnify"
                                                            >
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                        <a id="downloadLink" class="btn btn-outline-primary btn-sm  ml-2"
                                                           data-role="download-link" href="" download="">
                                                            <i class="fas fa-download"></i>
                                                        </a>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Card: Customer Details -->
                        <div class="col-md-5">
                            <div class=" p-3 border rounded-lg">
                                <div class="px-3 py-2 border rounded-lg">
                                    <h5 class="font-weight-bold">Customer Details</h5>
                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerId" class="col-sm-4  col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">Customer Id</label>
                                            <div class="col-sm-6 mt-2">                                               
                                                <span id="customerIdSpan" style="font-weight: 600;"></span>                                         
                                                <span id="inpCustomerIdSpan" style="font-weight: 600;"></span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerName" class="col-sm-4  col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">Customer Name</label>
                                            <div class="col-sm-6 mt-2">                                             
                                                <span id="customerNameSpan" style="font-weight: 600;"></span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col d-flex ">
                                            <label for="customerAddress" class="col-sm-4  col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">@L("Address")</label>
                                            <div class="col-sm-6 mt-2">                                         
                                                <span id="customerAddressSpan" style="font-weight: 600;"></span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerPAN" class="col-sm-4 col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">@L("PAN")</label>
                                            <div class="col-sm-6 mt-2">
                                                 <span id="customerPANSpan" style="font-weight: 600;"></span> 
                                            </div>
                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerGST" class="col-sm-4 col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">@L("GSTNo")</label>
                                            <div class="col-sm-6 mt-2">
                                                <span id="customerGSTSpan" style="font-weight: 600;"></span>
                                            </div>
                                        </div>

                                    </div>

                                </div>


                                <div class="px-3 py-2 border rounded-lg mt-2">
                                    <h5 class="font-weight-bold">Contact Information </h5>
                                    <div class="row">
                                        <div class="col d-flex align-items-center">
                                            <label for="customerEmail" class="col-sm-4 col-md-6 col-form-label"
                                                   style="font-size: 16px; font-weight: normal;">@L("Email")</label>
                                            <div class="col-sm-6 mt-2 " style="display: flex; align-items: end;">
                                                <span id="customerEmailSpan"
                                                      style="font-weight: 600; color: #007BFF; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerPhone" class="col-sm-4 col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">@L("Phone")</label>
                                            <div class="col-sm-8 mt-2">                                        
                                                <span id="customerPhoneSpan" style="font-weight: 600;"></span>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="row">
                                        <div class="col d-flex">
                                            <label for="customerWebsite" class="col-sm-4 col-md-6 col-form-label"
                                                style="font-size: 16px; font-weight: normal;">@L("Website")</label>
                                            <div class="col-sm-8 mt-2">
                                                <span id="customerWebsiteSpan" style="font-weight: 600; color: #007BFF;"></span>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                                <script>
                                    $(document).ready(function () {
                                        // Wait for a short delay to allow data to load
                                        setTimeout(function () {
                                            // Loop through all input fields and check for empty values
                                            $('input.form-control-disabled').each(function () {
                                                const fieldValue = $(this).val().trim();
                                                if (fieldValue === '') {
                                                    $(this).val('--'); // Set value to '--' if still empty
                                                }
                                            });

                                            // For <span> elements like customerAddressSpan
                                            $('span').each(function () {
                                                const spanValue = $(this).text().trim();
                                                if (spanValue === '') {
                                                    $(this).text('--'); // Set text to '--' if still empty
                                                }
                                            });
                                        }, 500); // Adjust delay (in ms) based on data loading time
                                    });
                                </script>

                            </div>
                        </div>
                    </div>

                    @* <hr class="custom-divider" /> *@

                    <!-- Second Section: Task Table -->

                    <div class="row mt-4 no-gutters">
                        <div class="col-12">
                            <div class="border rounded">
                                <table id="tblTask" class="table table-sm">
                                    <thead class="thead-light">
                                        <tr style="text-align: center; white-space:nowrap;font-size:14px;">
                                            <th>Materials</th>
                                            <th>Item Code</th>
                                            <th>Unit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>HSN Code</th>
                                            <th>Discount%</th>
                                            <th>CGST%</th>
                                            <th>SGST%</th>
                                            <th>IGST%</th>
                                            <th>Amount</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="taskRow">
                                            <td>
                                                <select class="form-control" id="materialName0"
                                                        onchange="fnFillMaterialInfo(this)">
                                                    <option value="" selected>Select @L("Material")</option>
                                                    @if (Model != null && Model.Materials != null)
                                                    {
                                                        @foreach (var v in Model.Materials)
                                                        {
                                                            <option value="@v.Id">@v.DisplayName</option>
                                                        }
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="hidden" id="hdnMaterialId0" name="MaterialId">
                                                <input type="hidden" id="hdnEstimateTaskId0">
                                                <input type="text" id="materialId0" class="form-control" readonly />
                                            </td>
                                            <td>
                                                <input type="hidden" id="unitId0">
                                                <select class="form-control" id="unitName0" >
                                                    <option value="" selected>Select @L("Unit")</option>
                                                    @if (Model != null && Model.Units != null)
                                                    {
                                                        @foreach (var v in Model.Units)
                                                        {
                                                            <option value="@v.Id">@v.UnitName</option>
                                                        }
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="number" id="quantity0" class="form-control"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="number" id="price0" class="form-control"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="text" id="hsnCode0" class="form-control" />@* onchange="CalculateTotalAmount()" *@
                                            </td>
                                            <td style="width:0px;">
                                                <input type="number" id="discount0" class="form-control  small-input"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="number" id="cGST0" class="form-control"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="number" id="sGST0" class="form-control"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="number" id="iGST0" class="form-control"
                                                    onchange="CalculateTotalAmount()" />
                                            </td>
                                            <td>
                                                <input type="number" id="amount0" class="form-control" />
                                            </td>
                                            <td class="text-center">
                                                <a href="javascript:void(0)"><i class="fas fa-trash fa-sm text-danger"
                                                        hidden></i></a>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="11" style="text-align: left;">
                                                <button type="button" class="btn btn-link" id="addRow"
                                                    style="color: #039855;">
                                                    <i class="fas fa-plus-circle" style="margin-right: 5px;"></i>
                                                    Add additional material
                                                </button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Third Section: Total Calculation -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="border rounded">
                                <table class="table table-md">
                                    <thead class="thead-light ">
                                        <tr style="font-weight: 700; font-size: 16px;">
                                            <th class="text-left col-11 py-2 pl-2 " colspan="2">Price Details</th>
                                            <!-- Changed td to th -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-left col-11  p-2">Gross Amount</td>
                                            <td id="divGrossAmount" class="text-right col-1 p-2">0.0</td>
                                        </tr>
                                        <tr>
                                            <td class="text-left  p-2">CGST</td>
                                            <td id="divCGST" class="text-right  p-2">0.0</td>
                                        </tr>
                                        <tr>
                                            <td class="text-left  p-2">SGST</td>
                                            <td id="divSGST" class="text-right  p-2">0.0</td>
                                        </tr>
                                        <tr>
                                            <td class="text-left  p-2">IGST</td>
                                            <td id="divIGST" class="text-right  p-2">0.0</td>
                                        </tr>
                                        <tr style="font-weight: 700; font-size: 20px; color: #007BFF;">
                                            <td class="text-lef  p-2">Total</td>
                                            <td id="divTotalAmount" name="TotalAmount" class="text-right  p-2">0.0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light border-top d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary mx-2" onclick="ShowPreview()"> <i
                            class="far fa-eye fa-sm mr-1"></i>@L("Preview")</button>
                    <button type="button" class="btn btn-outline-secondary mx-2" onclick="GeneratePdf()"> <i
                            class="far fa-file-pdf fa-sm mr-1"></i>@L("Pdf")</button>
                    <button type="button" class="btn btn-outline-secondary mx-2" onclick="SendApprovalEmail()"> <i
                            class="far fa-envelope fa-sm mr-1"></i>@L("Email")</button>
                    <button type="button" class="btn btn-success save-button mx-1" onclick="SaveEstimate()"> <i
                            class="far fa-save fa-sm mr-1"></i>@L("Save")</button>
                </div>
            </div>
        </form>
    </div>
</section>

@await Html.PartialAsync("~/Views/Shared/Modals/_EstimatePreviewModal.cshtml")

@section scripts
{
    <script src="~/view-resources/Views/CRM/Estimate.js" asp-append-version="true"></script>
    <script src="~/js/typeahead.js/typeahead.bundle.min.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/_Bundles/imageHelpers.min.js" asp-append-version="true"></script>
}
